<script>
  const drugOptions = {
    diabetic: [
      "Amitriptyline (EFNS, NICE, AAN, CPS)",
      "Duloxetine (EFNS, NICE, AAN, CPS)",
      "Venlafaxine (EFNS, NICE, AAN, CPS)",
      "Gabapentin (EFNS, AAN, CPS)",
      "Pregabalin (EFNS, NICE, AAN, CPS)"
    ],
    postherpetic: [
      "Amitriptyline (EFNS, NICE, CPS)",
      "Duloxetine (NICE)",
      "Venlafaxine (NICE)",
      "Gabapentin (EFNS, CPS)",
      "Pregabalin (EFNS, NICE, CPS)"
    ],
    trigeminal: [
      "Carbamazepine (EFNS, NICE, CPS)"
    ],
    central: [
      "Amitriptyline (EFNS, NICE)",
      "Duloxetine (NICE)",
      "Venlafaxine (NICE)",
      "Gabapentin (EFNS)",
      "Pregabalin (EFNS, NICE)"
    ],
    unspecified: [
      "Amitriptyline",
      "Duloxetine",
      "Venlafaxine",
      "Gabapentin",
      "Pregabalin",
      "Carbamazepine"
    ]
  };

  /* =========================================================
     IMPORTANT:
     VLOŽ SEM TVŮJ PŮVODNÍ OBROVSKÝ OBJECT "recommendations"
     (s těmi dlouhými HTML bloky).
     ========================================================= */
  const recommendations = {
    /* ... TVŮJ PŮVODNÍ OBSAH ... */
  };

  // --- helpers: vyříznout "Risk monitoring" a uložit ho bokem ---
  function extractRiskMonitoring(html) {
    const marker = "<b>Risk monitoring:</b>";
    const doseMarker = "<br><b>Dose adjustment:</b>";

    const start = html.indexOf(marker);
    if (start === -1) return { cleaned: html, monitoring: "" };

    const end = html.indexOf(doseMarker, start);
    if (end === -1) return { cleaned: html, monitoring: "" };

    const monitoring = html.slice(start, end);              // Risk monitoring část
    const cleaned = html.slice(0, start) + html.slice(end); // zbytek bez monitoringu

    return { cleaned, monitoring };
  }

  // --- show/hide monitoring pro všechny boxy ---
  function toggleMonitoring() {
    const cb = document.getElementById("toggleMonitoring");
    const show = cb && cb.checked;
    document.querySelectorAll(".monitoring-block").forEach(el => {
      el.style.display = show ? "block" : "none";
    });
  }

  function showMedications() {
    const painType = document.getElementById("painType").value;
    const medicationBox = document.getElementById("medicationsBox");
    const medicationSelect = document.getElementById("medication");
    const comorbidityBox = document.getElementById("comorbidityBox");
    const recommendation = document.getElementById("recommendation");

    // reset
    medicationSelect.innerHTML = '<option value="">-- Choose --</option>';
    recommendation.innerHTML = "";
    comorbidityBox.style.display = "none";

    // reset checkboxes
    document.querySelectorAll(".checkbox-group input[type='checkbox']").forEach(cb => cb.checked = false);

    if (painType && drugOptions[painType]) {
      drugOptions[painType].forEach(drug => {
        const option = document.createElement("option");
        option.textContent = drug;
        option.value = drug.split(" ")[0].toLowerCase(); // amitriptyline/duloxetine/...
        medicationSelect.appendChild(option);
      });
      medicationBox.style.display = "block";
    } else {
      medicationBox.style.display = "none";
    }
  }

  function showComorbidities() {
    document.getElementById("comorbidityBox").style.display = "block";
    document.getElementById("recommendation").innerHTML = "";
  }

  function showMultipleRecommendations() {
    const selectedMed = document.getElementById("medication").value;
    const checkboxes = document.querySelectorAll(".checkbox-group input[type='checkbox']");
    const recommendationBox = document.getElementById("recommendation");

    let resultMain = "";
    let resultMonitoring = "";
    let hasAnyMonitoring = false;

    checkboxes.forEach(checkbox => {
      if (
        checkbox.checked &&
        recommendations[selectedMed] &&
        recommendations[selectedMed][checkbox.value]
      ) {
        const rawHtml = recommendations[selectedMed][checkbox.value];

        // 1) vyříznout risk monitoring
        const parts = extractRiskMonitoring(rawHtml);

        // 2) přidat "cleaned" (bez monitoringu) do hlavního výsledku
        resultMain += parts.cleaned;

        // 3) monitoring ukládat bokem (až pro 4. krok)
        if (parts.monitoring) {
          hasAnyMonitoring = true;
          resultMonitoring += `
            <div class="recommendation-box" style="margin-top:10px;">
              ${parts.monitoring}
            </div>
          `;
        }
      }
    });

    if (!resultMain) {
      recommendationBox.innerHTML =
        '<div class="recommendation-box">No recommendation available for this combination.</div>';
      return;
    }

    // 4. krok: checkbox + skrytá sekce monitoringu
    const toggleHtml = hasAnyMonitoring
      ? `
        <div style="margin-top:15px;">
          <label style="display:block; font-size:16px;">
            <input type="checkbox" id="toggleMonitoring" onchange="toggleMonitoring()">
            Show risk monitoring
          </label>
        </div>
        <div class="monitoring-block" style="display:none; margin-top:10px;">
          ${resultMonitoring}
        </div>
      `
      : "";

    recommendationBox.innerHTML = resultMain + toggleHtml;

    // default: monitoring je skrytý
    toggleMonitoring();
  }
</script>
